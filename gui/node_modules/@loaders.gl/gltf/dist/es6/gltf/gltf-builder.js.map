{"version":3,"sources":["../../../src/gltf/gltf-builder.js"],"names":["GLBBuilder","packBinaryJson","assert","getImageSize","UBER_MESH_EXTENSION","UBER_POINT_CLOUD_EXTENSION","GLTFBuilder","constructor","options","DracoEncoder","DracoDecoder","Object","assign","json","meshes","addApplicationData","key","data","packOptions","jsonData","nopack","addExtraData","packedJson","extras","addExtension","extensionName","extensions","registerUsedExtension","addRequiredExtension","registerRequiredExtension","extensionsUsed","find","ext","push","extensionsRequired","addMesh","attributes","indices","mode","accessors","_addAttributes","glTFMesh","primitives","length","addPointCloud","accessorIndices","addCompressedMesh","Error","dracoEncoder","compressedData","encodeMesh","dracoDecoder","decodedData","decodeMesh","fauxAccessors","_addFauxAttributes","bufferViewIndex","addBufferView","bufferView","addCompressedPointCloud","encodePointCloud","addImage","imageData","sizeAndType","mimeType","width","height","images"],"mappings":"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","sourcesContent":["/* eslint-disable camelcase, max-statements */\nimport GLBBuilder from '../glb/glb-builder';\nimport packBinaryJson from '../packed-json/pack-binary-json';\nimport {\n  assert,\n  getImageSize\n} from '@loaders.gl/core';\n\n// Ideally we should just use KHR_draco_mesh_compression, but it requires saving uncompressed data?\n// TODO: until the ideal, we need to export these\nconst UBER_MESH_EXTENSION = 'UBER_draco_mesh_compression';\nconst UBER_POINT_CLOUD_EXTENSION = 'UBER_draco_point_cloud_compression';\n\nexport default class GLTFBuilder extends GLBBuilder {\n  constructor(options = {}) {\n    super(options);\n\n    // Soft dependency on DRACO, app needs to import and supply these\n    this.DracoEncoder = options.DracoEncoder;\n    this.DracoDecoder = options.DracoDecoder;\n\n    Object.assign(this.json, {\n      meshes: []\n    });\n  }\n\n  // TODO - support encoding to non-GLB versions of glTF format\n\n  // Encode as a textual JSON file with binary data in base64 data URLs.\n  // encodeAsDataURLs(options) {\n  //   throw new Error('Not yet implemented');\n  // }\n\n  // Encode as a JSON with all images (and buffers?) in separate binary files\n  // encodeAsSeparateFiles(options) {\n  //   throw new Error('Not yet imlemented');\n  // }\n\n  // Add an extra application-defined key to the top-level data structure\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addApplicationData(key, data, packOptions = {}) {\n    const jsonData = packOptions.nopack ? data : packBinaryJson(data, this, packOptions);\n    this.json[key] = jsonData;\n    return this;\n  }\n\n  // `extras` - Standard GLTF field for storing application specific data\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtraData(key, data, packOptions = {}) {\n    const packedJson = !packOptions.nopack && packBinaryJson(data, this, packOptions);\n    this.json.extras = this.json.extras || {};\n    this.json.extras[key] = packedJson;\n    return this;\n  }\n\n  // Add to standard GLTF top level extension object, mark as used\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = !packOptions.nopack && packBinaryJson(data, this, packOptions);\n    this.json.extensions = this.json.extensions || {};\n    this.json.extensions[extensionName] = packedJson;\n    this.registerUsedExtension(extensionName);\n    return this;\n  }\n\n  // Standard GLTF top level extension object, mark as used and required\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addRequiredExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = !packOptions.nopack && packBinaryJson(data, this, packOptions);\n    this.addExtension(extensionName, packedJson);\n    this.registerRequiredExtension(extensionName);\n    return this;\n  }\n\n  // Add extensionName to list of used extensions\n  registerUsedExtension(extensionName) {\n    this.json.extensionsUsed = this.json.extensionsUsed || [];\n    if (!this.json.extensionsUsed.find(ext => ext === extensionName)) {\n      this.json.extensionsUsed.push(extensionName);\n    }\n  }\n\n  // Add extensionName to list of required extensions\n  registerRequiredExtension(extensionName) {\n    this.registerUsedExtension(extensionName);\n    this.json.extensionsRequired = this.json.extensionsRequired || [];\n    if (!this.json.extensionsRequired.find(ext => ext === extensionName)) {\n      this.json.extensionsRequired.push(extensionName);\n    }\n  }\n\n  // POINTS:  0x0000,\n  // LINES: 0x0001,\n  // LINE_LOOP: 0x0002,\n  // LINE_STRIP:  0x0003,\n  // TRIANGLES: 0x0004,\n  // TRIANGLE_STRIP:  0x0005,\n  // TRIANGLE_FAN:  0x0006,\n\n  addMesh(attributes, indices, mode = 4) {\n    const accessors = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessors,\n          indices,\n          mode\n        }\n      ]\n    };\n\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addPointCloud(attributes) {\n    const accessorIndices = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessorIndices,\n          mode: 0 // GL.POINTS\n        }\n      ]\n    };\n\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/\n  //   KHR_draco_mesh_compression\n  // NOTE: in contrast to glTF spec, does not add fallback data\n  addCompressedMesh(attributes, indices, mode = 4) {\n    if (!this.DracoEncoder || !this.DracoDecoder) {\n      throw new Error('DracoEncoder/Decoder not available');\n    }\n\n    const dracoEncoder = new this.DracoEncoder();\n    const compressedData = dracoEncoder.encodeMesh(attributes);\n\n    // Draco compression may change the order and number of vertices in a mesh.\n    // To satisfy the requirement that accessors properties be correct for both\n    // compressed and uncompressed data, generators should create uncompressed\n    // attributes and indices using data that has been decompressed from the Draco buffer,\n    // rather than the original source data.\n    const dracoDecoder = new this.DracoDecoder();\n    const decodedData = dracoDecoder.decodeMesh(attributes);\n    const fauxAccessors = this._addFauxAttributes(decodedData.attributes);\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: fauxAccessors,\n          mode, // GL.POINTS\n          extensions: {\n            [UBER_MESH_EXTENSION]: {\n              bufferView: bufferViewIndex\n            }\n          }\n        }\n      ]\n    };\n\n    this.registerRequiredExtension(UBER_MESH_EXTENSION);\n\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addCompressedPointCloud(attributes) {\n    if (!this.DracoEncoder || !this.DracoDecoder) {\n      throw new Error('DracoEncoder/Decoder not available');\n    }\n\n    const dracoEncoder = new this.DracoEncoder();\n    const compressedData = dracoEncoder.encodePointCloud(attributes);\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: {}, // This will be populated after decompression\n          mode: 0, // GL.POINTS\n          extensions: {\n            [UBER_POINT_CLOUD_EXTENSION]: {\n              bufferView: bufferViewIndex\n            }\n          }\n        }\n      ]\n    };\n\n    this.registerRequiredExtension(UBER_POINT_CLOUD_EXTENSION);\n\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // Adds a binary image. Builds glTF \"JSON metadata\" and saves buffer reference\n  // Buffer will be copied into BIN chunk during \"pack\"\n  // Currently encodes as glTF image\n  addImage(imageData) {\n    const bufferViewIndex = this.addBufferView(imageData);\n\n    // Get the properties of the image to add as metadata.\n    const sizeAndType = getImageSize(imageData) || {};\n    if (sizeAndType) {\n      // width and height are non-spec fields\n      const {mimeType, width, height} = sizeAndType;\n      this.json.images.push({\n        bufferView: bufferViewIndex,\n        mimeType,\n        width,\n        height\n      });\n    } else {\n      // TODO: Spec violation, if we are using a bufferView, mimeType must be defined\n      //       https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#images\n      //       \"a reference to a bufferView; in that case mimeType must be defined.\"\n      this.json.images.push({\n        bufferView: bufferViewIndex\n      });\n    }\n\n    return this.json.images.length - 1;\n  }\n}\n"],"file":"gltf-builder.js"}