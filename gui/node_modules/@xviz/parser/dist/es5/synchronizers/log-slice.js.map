{"version":3,"sources":["../../../src/synchronizers/log-slice.js"],"names":["lookAheadTimesliceAccessor","timeslice","length","timestamp","log","warn","updateObjects","streamName","features","feature","xvizObject","XVIZObject","get","id","_addFeature","LogSlice","streamFilter","lookAheadMs","streamsByReverseTime","variables","pointCloud","lookAheads","components","streams","initialize","params","postProcessFrame","vehiclePose","OBJECT_STREAM","frame","resetAll","objects","getAllInCurrentFrame","filter","Object","keys","forEach","_includeStream","addStreamDatum","datum","setLabelsOnXVIZObjects","labels","variable","lookAheadTime","time","lookAheadIndex","INSERT_POSITION","RIGHT","console","undefined","label","object","labelName","_setProp","value","stream","defaultValue","streamData"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {getXVIZConfig} from '../config/xviz-config';\nimport XVIZObject from '../objects/xviz-object';\nimport {findInsertPos, INSERT_POSITION} from '../utils/search';\nimport log from '../utils/log';\n\nimport {getTransformsFromPose} from '../parsers/parse-vehicle-pose';\n\n// lookAheads is an array of arrays, so we need to fetch out the first\n// timestamp of the inner array.\nfunction lookAheadTimesliceAccessor(timeslice) {\n  if (timeslice && timeslice.length) {\n    return timeslice[0].timestamp;\n  }\n\n  log.warn('Missing entry or timestamp in lookAhead array')();\n  return 0;\n}\n\nfunction updateObjects(streamName, features) {\n  for (const feature of features) {\n    const xvizObject = XVIZObject.get(feature.id);\n    if (xvizObject) {\n      xvizObject._addFeature(streamName, feature);\n    }\n  }\n}\n\n// LOGSLICE CLASS\n\n// One time slice, one datum from each stream.\nexport default class LogSlice {\n  constructor(streamFilter, lookAheadMs, streamsByReverseTime) {\n    this.features = {};\n    this.variables = {};\n    this.pointCloud = null;\n    this.lookAheads = {};\n    this.components = {};\n    this.streams = {};\n\n    this.initialize(streamFilter, lookAheadMs, streamsByReverseTime);\n  }\n\n  // Extract car data from vehicle_pose and get geoJson for related frames\n  /* eslint-disable max-statements */\n  getCurrentFrame(params, postProcessFrame) {\n    const {vehiclePose} = params;\n    if (!vehiclePose) {\n      return null;\n    }\n\n    const {OBJECT_STREAM} = getXVIZConfig();\n\n    const frame = {\n      ...params,\n      ...getTransformsFromPose(vehiclePose),\n      vehiclePose,\n      features: this.features,\n      lookAheads: this.lookAheads,\n      variables: this.variables,\n      pointCloud: this.pointCloud,\n      components: this.components,\n      streams: this.streams\n    };\n\n    // OBJECTS\n    XVIZObject.resetAll();\n    if (postProcessFrame) {\n      postProcessFrame(frame);\n    }\n\n    // OBJECT_STREAM is deprecated, only keeping for backward compatibility\n    if (OBJECT_STREAM) {\n      updateObjects(OBJECT_STREAM, this.features[OBJECT_STREAM] || []);\n    } else {\n      for (const streamName in this.features) {\n        const features = this.features[streamName];\n        if (features.length && features[0].id) {\n          updateObjects(streamName, features);\n        }\n      }\n    }\n\n    frame.objects = XVIZObject.getAllInCurrentFrame(); // Map of XVIZ ids in current slice\n\n    return frame;\n  }\n  /* eslint-enable max-statements */\n\n  // HELPER METHODS\n\n  /**\n   * In-contrast to the per-stream post-processors,\n   * this function has the ability to look at and correlate data from multiple streams.\n   * Among other things parses XVIZ Object-related info from misc streams and merge into XVIZ\n   * feature properties.\n   */\n  initialize(streamFilter, lookAheadMs, streamsByReverseTime) {\n    const filter = streamFilter && Object.keys(streamFilter).length > 0 ? streamFilter : null;\n\n    // get data if we don't already have that stream && it is not filtered.\n    streamsByReverseTime.forEach(streams => {\n      for (const streamName in streams) {\n        if (!this.streams[streamName] && this._includeStream(filter, streamName)) {\n          this.addStreamDatum(streams[streamName], streamName, lookAheadMs, this);\n        }\n      }\n    });\n  }\n\n  /**\n   * Process a stream and put the appropriate data into\n   */\n  addStreamDatum(datum, streamName, lookAheadMs) {\n    this.streams[streamName] = datum;\n\n    this.setLabelsOnXVIZObjects(datum.labels);\n\n    const {features = [], lookAheads = [], variable, pointCloud = null} = datum;\n\n    // Future data is separate from features so we can control independently\n    if (lookAheads.length && lookAheadMs > 0) {\n      const lookAheadTime = datum.time + lookAheadMs;\n      const lookAheadIndex = findInsertPos(\n        lookAheads,\n        lookAheadTime,\n        INSERT_POSITION.RIGHT,\n        lookAheadTimesliceAccessor\n      );\n\n      if (lookAheadIndex) {\n        this.lookAheads[streamName] = lookAheads[lookAheadIndex - 1];\n      }\n    }\n\n    // Combine data from current datums\n    if (features.length) {\n      this.features[streamName] = features;\n    }\n\n    // Point cloud\n    if (pointCloud) {\n      if (this.pointCloud) {\n        console.warn(`Point cloud for ${streamName} overwriting previous cloud`); // eslint-disable-line\n      }\n      this.pointCloud = pointCloud;\n    }\n\n    if (variable !== undefined) {\n      this.variables[streamName] = variable;\n    }\n  }\n\n  setLabelsOnXVIZObjects(labels = []) {\n    // Sort labels by id\n    labels.forEach(label => {\n      const object = XVIZObject.get(label.id);\n      if (object && label.labelName) {\n        // Extract label name (acceleration, velocity etc.) from stream name\n\n        // For streams that do not follow the simple pattern in STREAM_REGEXP\n        // Lookup for exact matches for labels first.\n        object._setProp(label.labelName, label.value);\n      }\n    });\n  }\n\n  // Helper function to get a stream from data\n  // @param {Object} data - log data\n  // @param {String} stream - name of stream\n  // @param {*} defaultValue={} - return value in case stream is not present\n  // @return {Object} - contents of stream or defaultValue\n  getStream(stream, defaultValue = {}) {\n    const streamData = this.streams[stream];\n    if (!streamData) {\n      return defaultValue;\n    }\n    return streamData;\n  }\n\n  _includeStream(streamFilter, streamName) {\n    return !streamFilter || streamFilter[streamName];\n  }\n}\n"],"file":"log-slice.js"}