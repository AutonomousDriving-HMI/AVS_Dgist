{"version":3,"sources":["../../../src/workers/stream-data-worker.js"],"names":["config","self","onResult","message","transfers","Set","type","LOG_STREAM_MESSAGE","TIMESLICE","streamName","streams","stream","pointCloud","images","length","forEach","image","VIDEO_FRAME","imageData","postMessage","Array","from","onError","error","onmessage","e","data","xvizConfig"],"mappings":";;;;;;;AAcA;;AACA;;AACA;;AACA;;AACA;;AAlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;eAQe,kBAAAA,MAAM;AAAA,SAAI,UAAAC,IAAI,EAAI;AAC/B,mCAAcD,MAAd;;AAEA,aAASE,QAAT,CAAkBC,OAAlB,EAA2B;AACzB,UAAMC,SAAS,GAAG,IAAIC,GAAJ,EAAlB;;AAEA,cAAQF,OAAO,CAACG,IAAhB;AACE,aAAKC,8BAAmBC,SAAxB;AACE,eAAK,IAAMC,UAAX,IAAyBN,OAAO,CAACO,OAAjC,EAA0C;AACxC,gBAAMC,MAAM,GAAGR,OAAO,CAACO,OAAR,CAAgBD,UAAhB,CAAf;AACA,8CAAgBE,MAAM,CAACC,UAAvB,EAAmC,IAAnC,EAAyCR,SAAzC;;AACA,gBAAIO,MAAM,CAACE,MAAP,IAAiBF,MAAM,CAACE,MAAP,CAAcC,MAAnC,EAA2C;AACzCH,cAAAA,MAAM,CAACE,MAAP,CAAcE,OAAd,CAAsB,UAAAC,KAAK;AAAA,uBAAI,kCAAgBA,KAAhB,EAAuB,IAAvB,EAA6BZ,SAA7B,CAAJ;AAAA,eAA3B;AACD;AACF;;AACD;;AAEF,aAAKG,8BAAmBU,WAAxB;AACE;AACA,4CAAgBd,OAAO,CAACe,SAAxB,EAAmC,KAAnC,EAA0Cd,SAA1C;AACA;;AAEF;AAhBF;;AAmBAD,MAAAA,OAAO,GAAG,6BAAaA,OAAb,CAAV;AAEA;AACA;AACA;AACA;AACA;;AAEAF,MAAAA,IAAI,CAACkB,WAAL,CAAiBhB,OAAjB,EAA0BiB,KAAK,CAACC,IAAN,CAAWjB,SAAX,CAA1B;AACD;;AAED,aAASkB,OAAT,CAAiBC,KAAjB,EAAwB;AACtB,YAAMA,KAAN;AACD;;AAEDtB,IAAAA,IAAI,CAACuB,SAAL,GAAiB,UAAAC,CAAC,EAAI;AACpB,UAAIA,CAAC,CAACC,IAAF,IAAUD,CAAC,CAACC,IAAF,CAAOC,UAArB,EAAiC;AAC/B,uCAAcF,CAAC,CAACC,IAAF,CAAOC,UAArB;AACD,OAFD,MAEO,IAAIF,CAAC,CAACC,IAAN,EAAY;AACjB,4DAAuBD,CAAC,CAACC,IAAzB,EAA+BxB,QAA/B,EAAyCoB,OAAzC;AACD;AACF,KAND;AAOD,GA/CoB;AAAA,C","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {setXVIZConfig} from '../config/xviz-config';\nimport {parseStreamDataMessage} from '../parsers/parse-stream-data-message';\nimport {preSerialize} from '../parsers/serialize';\nimport {getTransferList} from '../utils/worker-utils';\nimport {LOG_STREAM_MESSAGE} from '../constants';\n\nexport default config => self => {\n  setXVIZConfig(config);\n\n  function onResult(message) {\n    const transfers = new Set();\n\n    switch (message.type) {\n      case LOG_STREAM_MESSAGE.TIMESLICE:\n        for (const streamName in message.streams) {\n          const stream = message.streams[streamName];\n          getTransferList(stream.pointCloud, true, transfers);\n          if (stream.images && stream.images.length) {\n            stream.images.forEach(image => getTransferList(image, true, transfers));\n          }\n        }\n        break;\n\n      case LOG_STREAM_MESSAGE.VIDEO_FRAME:\n        // v1 video stream\n        getTransferList(message.imageData, false, transfers);\n        break;\n\n      default:\n    }\n\n    message = preSerialize(message);\n\n    /* uncomment for debug */\n    // message._size = {\n    //   arraybuffer: transfers.size\n    // };\n    // message._sentAt = Date.now();\n\n    self.postMessage(message, Array.from(transfers));\n  }\n\n  function onError(error) {\n    throw error;\n  }\n\n  self.onmessage = e => {\n    if (e.data && e.data.xvizConfig) {\n      setXVIZConfig(e.data.xvizConfig);\n    } else if (e.data) {\n      parseStreamDataMessage(e.data, onResult, onError);\n    }\n  };\n};\n"],"file":"stream-data-worker.js"}