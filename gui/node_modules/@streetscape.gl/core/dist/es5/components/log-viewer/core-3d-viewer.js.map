{"version":3,"sources":["../../../../src/components/log-viewer/core-3d-viewer.js"],"names":["noop","getStreamMetadata","metadata","streamName","streams","Core3DViewer","props","viewState","oldViewState","viewOffset","onViewStateChange","info","evt","objectId","object","id","isHovering","Boolean","onHover","infos","isRightClick","which","onContextMenu","onClick","state","styleParser","_getStyleParser","nextProps","viewMode","DEFAULT_VIEW_STATE","initialViewState","x","y","bearing","xvizStyles","setState","XVIZStyleParser","styles","frame","car","origin","DEFAULT_ORIGIN","mesh","scale","wireframe","texture","color","MeshLayer","opacity","coordinateSystem","COORDINATE_SYSTEM","METER_OFFSETS","coordinateOrigin","modelMatrix","vehicleRelativeTransform","clone","translate","data","CAR_DATA","getPosition","d","getColor","getSize","Number","isFinite","lightSettings","LIGHT_SETTINGS","showTooltip","objectStates","customLayers","getTransformMatrix","lookAheads","streamFilter","featuresAndFutures","Set","Object","keys","concat","filter","_getCarLayer","Array","from","map","stream","streamMetadata","coordinateProps","stylesheet","getStylesheet","primitives","features","length","XVIZLayer","pickable","style","zIndex","type","pointCloud","sort","layer1","layer2","layer","additionalProps","assign","coordinate","constructor","viewport","isPicking","trackedPosition","longitude","trackPosition","latitude","heading","offset","mapboxApiAccessToken","renderObjectLabel","mapStyle","showMap","_getViewState","_getLayers","_layerFilter","_getCursor","_onLayerHover","_onLayerClick","_onViewStateChange","firstPerson","selected","children","PureComponent","PropTypes","bool","string","oneOfType","array","func","DEFAULT_CAR","VIEW_MODE","PERSPECTIVE"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {StaticMap} from 'react-map-gl';\nimport DeckGL, {COORDINATE_SYSTEM} from 'deck.gl';\n\nimport ObjectLabelsOverlay from './object-labels-overlay';\n\nimport MeshLayer from '../../layers/mesh-layer/mesh-layer';\nimport {XVIZStyleParser} from '@xviz/parser';\n\nimport XVIZLayer from '../../layers/xviz-layer';\n\nimport {VIEW_MODE, DEFAULT_VIEW_STATE} from '../../constants';\nimport {getViewStateOffset, getViews, getViewStates} from '../../utils/viewport';\nimport {resolveCoordinateTransform} from '../../utils/transform';\nimport {mergeXVIZStyles} from '../../utils/style';\nimport {normalizeStreamFilter} from '../../utils/stream-utils';\n\nimport {DEFAULT_ORIGIN, CAR_DATA, LIGHT_SETTINGS, DEFAULT_CAR} from './constants';\n\nconst noop = () => {};\n\nfunction getStreamMetadata(metadata, streamName) {\n  return (metadata && metadata.streams && metadata.streams[streamName]) || {};\n}\n\nexport default class Core3DViewer extends PureComponent {\n  static propTypes = {\n    // Props from loader\n    frame: PropTypes.object,\n    metadata: PropTypes.object,\n\n    // Rendering options\n    showMap: PropTypes.bool,\n    showTooltip: PropTypes.bool,\n    mapboxApiAccessToken: PropTypes.string,\n    mapStyle: PropTypes.oneOfType([PropTypes.object, PropTypes.string]),\n    xvizStyles: PropTypes.object,\n    car: PropTypes.object,\n    viewMode: PropTypes.object,\n    streamFilter: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.array,\n      PropTypes.object,\n      PropTypes.func\n    ]),\n    customLayers: PropTypes.array,\n    renderObjectLabel: PropTypes.func,\n    getTransformMatrix: PropTypes.func,\n\n    // Callbacks\n    onHover: PropTypes.func,\n    onClick: PropTypes.func,\n    onContextMenu: PropTypes.func,\n    onViewStateChange: PropTypes.func,\n\n    // States\n    viewState: PropTypes.object,\n    viewOffset: PropTypes.object,\n    objectStates: PropTypes.object\n  };\n\n  static defaultProps = {\n    car: DEFAULT_CAR,\n    viewMode: VIEW_MODE.PERSPECTIVE,\n    xvizStyles: {},\n    customLayers: [],\n    onViewStateChange: noop,\n    onHover: noop,\n    onClick: noop,\n    onContextMenu: noop,\n    showMap: true,\n    showTooltip: false\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      styleParser: this._getStyleParser(props)\n    };\n  }\n\n  componentWillReceiveProps(nextProps) {\n    if (this.props.viewMode !== nextProps.viewMode) {\n      const viewState = {\n        ...this.props.viewState,\n        ...DEFAULT_VIEW_STATE,\n        ...nextProps.viewMode.initialViewState\n      };\n      // Reset offset\n      const viewOffset = {\n        x: 0,\n        y: 0,\n        bearing: 0\n      };\n\n      nextProps.onViewStateChange({viewState, viewOffset});\n    }\n    if (\n      this.props.metadata !== nextProps.metadata ||\n      this.props.xvizStyles !== nextProps.xvizStyles\n    ) {\n      this.setState({\n        styleParser: this._getStyleParser(nextProps)\n      });\n    }\n  }\n\n  _onViewStateChange = ({viewState, oldViewState}) => {\n    const viewOffset = getViewStateOffset(oldViewState, viewState, this.props.viewOffset);\n    this.props.onViewStateChange({viewState, viewOffset});\n  };\n\n  _onLayerHover = (info, evt) => {\n    const objectId = info && info.object && info.object.id;\n    this.isHovering = Boolean(objectId);\n    this.props.onHover(info, evt);\n  };\n\n  _onLayerClick = (info, infos, evt) => {\n    const isRightClick = evt.which === 3;\n\n    if (isRightClick) {\n      this.props.onContextMenu(info, evt);\n    } else {\n      this.props.onClick(info, evt);\n    }\n  };\n\n  _getStyleParser({metadata, xvizStyles}) {\n    return new XVIZStyleParser(mergeXVIZStyles(metadata && metadata.styles, xvizStyles));\n  }\n\n  _getCarLayer() {\n    const {frame, car} = this.props;\n    const {\n      origin = DEFAULT_ORIGIN,\n      mesh,\n      scale = [1, 1, 1],\n      wireframe = false,\n      texture = null,\n      color = [0, 0, 0]\n    } = car;\n\n    return new MeshLayer({\n      id: 'car',\n      opacity: 1,\n      coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n      coordinateOrigin: frame.origin || DEFAULT_ORIGIN,\n      // Adjust for car center position relative to GPS/IMU\n      modelMatrix: frame.vehicleRelativeTransform.clone().translate(origin),\n      mesh,\n      data: CAR_DATA,\n      getPosition: d => d,\n      getColor: color,\n      // Support old scale format\n      getSize: Number.isFinite(scale) ? [scale, scale, scale] : scale,\n      texture,\n      wireframe,\n      lightSettings: LIGHT_SETTINGS\n    });\n  }\n\n  _getLayers() {\n    const {\n      frame,\n      metadata,\n      showTooltip,\n      objectStates,\n      customLayers,\n      getTransformMatrix\n    } = this.props;\n    if (!frame || !metadata) {\n      return [];\n    }\n\n    const {streams, lookAheads = {}} = frame;\n    const {styleParser} = this.state;\n\n    const streamFilter = normalizeStreamFilter(this.props.streamFilter);\n    const featuresAndFutures = new Set(\n      Object.keys(streams)\n        .concat(Object.keys(lookAheads))\n        .filter(streamFilter)\n    );\n\n    return [\n      this._getCarLayer(),\n      Array.from(featuresAndFutures)\n        .map(streamName => {\n          // Check lookAheads first because it will contain the selected futures\n          // while streams would contain the full futures array\n          const stream = lookAheads[streamName] || streams[streamName];\n          const streamMetadata = getStreamMetadata(metadata, streamName);\n          const coordinateProps = resolveCoordinateTransform(\n            frame,\n            streamMetadata,\n            getTransformMatrix\n          );\n\n          const stylesheet = styleParser.getStylesheet(streamName);\n\n          // Support both features and lookAheads, respectively\n          const primitives = stream.features || stream;\n          if (primitives && primitives.length) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: showTooltip || primitives[0].id,\n              lightSettings: LIGHT_SETTINGS,\n\n              data: primitives,\n              style: stylesheet,\n              objectStates,\n\n              // Hack: draw extruded polygons last to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: primitives[0].type === 'polygon' ? 2 : 0,\n\n              // Selection props (app defined, not used by deck.gl)\n              streamName\n            });\n          }\n          if (stream.pointCloud) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: showTooltip,\n              data: stream.pointCloud,\n              style: stylesheet,\n              vehicleRelativeTransform: frame.vehicleRelativeTransform,\n\n              // Hack: draw point clouds before polygons to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: 1,\n\n              streamName\n            });\n          }\n          return null;\n        })\n        .filter(Boolean)\n        .sort((layer1, layer2) => layer1.props.zIndex - layer2.props.zIndex),\n      customLayers.map(layer => {\n        // Clone layer props\n        const {props} = layer;\n        const additionalProps = {};\n\n        if (props.streamName) {\n          // Use log data\n          const stream = streams[props.streamName];\n          const streamMetadata = getStreamMetadata(metadata, props.streamName);\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, streamMetadata, getTransformMatrix),\n            {\n              data: stream && stream.features\n            }\n          );\n        } else if (props.coordinate) {\n          // Apply log-specific coordinate props\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, props, getTransformMatrix)\n          );\n        } else {\n          return layer;\n        }\n\n        return new layer.constructor(props, additionalProps);\n      })\n    ];\n  }\n\n  _layerFilter({layer, viewport, isPicking}) {\n    if (viewport.id === 'driver') {\n      return layer.id !== 'car';\n    }\n    return true;\n  }\n\n  _getCursor = () => {\n    return this.isHovering ? 'pointer' : 'crosshair';\n  };\n\n  _getViewState() {\n    const {viewMode, frame, viewState, viewOffset} = this.props;\n\n    const trackedPosition = frame\n      ? {\n          longitude: frame.trackPosition[0],\n          latitude: frame.trackPosition[1],\n          bearing: 90 - frame.heading\n        }\n      : null;\n\n    return getViewStates({viewState, viewMode, trackedPosition, offset: viewOffset});\n  }\n\n  render() {\n    const {\n      mapboxApiAccessToken,\n      frame,\n      metadata,\n      objectStates,\n      renderObjectLabel,\n      getTransformMatrix,\n      style,\n      mapStyle,\n      viewMode,\n      showMap\n    } = this.props;\n    const {styleParser} = this.state;\n\n    return (\n      <DeckGL\n        width=\"100%\"\n        height=\"100%\"\n        views={getViews(viewMode)}\n        viewState={this._getViewState()}\n        layers={this._getLayers()}\n        layerFilter={this._layerFilter}\n        getCursor={this._getCursor}\n        onLayerHover={this._onLayerHover}\n        onLayerClick={this._onLayerClick}\n        onViewStateChange={this._onViewStateChange}\n      >\n        {showMap && (\n          <StaticMap\n            reuseMap={true}\n            attributionControl={false}\n            mapboxApiAccessToken={mapboxApiAccessToken}\n            mapStyle={mapStyle}\n            visible={frame && frame.origin && !viewMode.firstPerson}\n          />\n        )}\n\n        <ObjectLabelsOverlay\n          objectSelection={objectStates.selected}\n          frame={frame}\n          metadata={metadata}\n          renderObjectLabel={renderObjectLabel}\n          xvizStyleParser={styleParser}\n          style={style}\n          getTransformMatrix={getTransformMatrix}\n        />\n\n        {this.props.children}\n      </DeckGL>\n    );\n  }\n}\n"],"file":"core-3d-viewer.js"}