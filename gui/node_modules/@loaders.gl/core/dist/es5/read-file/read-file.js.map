{"version":3,"sources":["../../../src/read-file/read-file.js"],"names":["isNode","Boolean","fs","readFile","DEFAULT_OPTIONS","dataType","getReadFileOptions","options","Object","assign","responseType","encoding","uri","alias","Promise","resolve","startsWith","File","readFileObject","isRequest","http","request","createImageBitmap","URL","location","pathname","href","fetch","then","res","readFileNode","reject","Error","error","message","readFileSync","buffer","Buffer","file","reader","FileReader","onerror","onabort","onload","result","readAsText","readAsArrayBuffer","filename","readFileAsync","util","promisify"],"mappings":"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","sourcesContent":["/* global fetch */\n/* global URL, location, File, FileReader */\n/* global Buffer */\nimport {getPathPrefix} from './path-prefix';\nimport {getFileAlias} from './file-aliases';\nimport decodeDataUri from '../data-uri-utils/decode-data-uri';\nimport {toArrayBuffer} from '../binary-utils/binary-utils';\nimport fs from 'fs'; // `fs` will be empty object in browsers (see package.json \"browser\" field).\nimport http from 'http';\nimport util from 'util';\n\nconst isNode = Boolean(fs && fs.readFile);\n\nconst DEFAULT_OPTIONS = {\n  dataType: 'arraybuffer'\n};\n\nfunction getReadFileOptions(options = {}) {\n  options = Object.assign({}, DEFAULT_OPTIONS, options);\n  options.responseType = options.responseType || options.dataType;\n  if (fs) {\n    // set encoding for fs.readFile\n    options.encoding = options.encoding || (options.dataType === 'text' ? 'utf8' : null);\n  }\n  return options;\n}\n\n// Reads raw file data from:\n// * http/http urls\n// * data urls\n// * File/Blob objects\n// etc?\nexport function readFile(uri, options = {}) {\n  try {\n    options = getReadFileOptions(options);\n    uri = getPathPrefix() + uri;\n\n    const alias = getFileAlias(uri);\n    if (alias) {\n      return Promise.resolve(alias);\n    }\n\n    if (uri.startsWith('data:')) {\n      return Promise.resolve(decodeDataUri(uri));\n    }\n\n    if (typeof File !== 'undefined' && uri instanceof File) {\n      readFileObject(uri, options);\n    }\n\n    const isRequest = uri.startsWith('http:') || uri.startsWith('https:');\n    if (isRequest) {\n      if (isNode) {\n        return http.request(uri, options);\n      }\n      if (typeof createImageBitmap === 'undefined') {\n        // In a web worker: XMLHttpRequest throws invalid URL error if using relative path\n        // resolve url relative to original base\n        uri = new URL(uri, location.pathname).href;\n      }\n      return fetch(uri, options).then(res => res[options.dataType]());\n    }\n\n    if (isNode) {\n      return readFileNode(uri, options);\n    }\n\n    return Promise.reject(new Error('Cannot load file URIs in browser'));\n  } catch (error) {\n    return Promise.reject(error.message);\n  }\n}\n\n// In a few cases (data URIs, node.js) \"files\" can be read synchronously\nexport function readFileSync(uri, options = {}) {\n  options = getReadFileOptions(options);\n  uri = getPathPrefix() + uri;\n\n  const alias = getFileAlias(uri);\n  if (alias) {\n    return alias;\n  }\n\n  if (uri.startsWith('data:')) {\n    return decodeDataUri(uri);\n  }\n\n  if (!isNode) {\n    return null; // throw new Error('Cant load URI synchronously');\n  }\n\n  const buffer = fs.readFileSync(uri, options, () => {});\n  return buffer instanceof Buffer ? toArrayBuffer(buffer) : buffer;\n}\n\n// HELPERS\n\n/**\n * File reader function for the browser\n * @param {File|Blob} file  HTML File or Blob object to read as string\n * @returns {Promise.string}  Resolves to a string containing file contents\n */\nfunction readFileObject(file, options) {\n  return new Promise((resolve, reject) => {\n    try {\n      const reader = new FileReader();\n      reader.onerror = error => reject(new Error(error));\n      reader.onabort = () => reject(new Error('Read operation was aborted.'));\n      reader.onload = () => resolve(reader.result);\n      if (options.dataType !== 'arraybuffer') {\n        reader.readAsText(file);\n      } else {\n        reader.readAsArrayBuffer(file);\n      }\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n\nfunction readFileNode(filename, options) {\n  const readFileAsync = util.promisify(fs.readFile);\n  return readFileAsync(filename, options).then(\n    buffer => buffer instanceof Buffer ? toArrayBuffer(buffer) : buffer\n  );\n}\n\n"],"file":"read-file.js"}