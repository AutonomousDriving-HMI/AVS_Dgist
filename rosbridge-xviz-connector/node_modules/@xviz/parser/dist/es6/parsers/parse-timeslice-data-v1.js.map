{"version":3,"sources":["../../../src/parsers/parse-timeslice-data-v1.js"],"names":["getXVIZConfig","LOG_STREAM_MESSAGE","parseStreamFutures","parseStreamPrimitive","parseStreamVariable","parseTimesliceData","data","convertPrimitive","PRIMARY_POSE_STREAM","vehiclePose","vehicle_pose","stateUpdates","state_updates","otherInfo","timestamp","time","reduce","t","stateUpdate","Math","max","type","INCOMPLETE","newStreams","result","TIMESLICE","streams","xvizStreams","parseStateUpdates","Object","assign","STREAM_BLACKLIST","primitives","variables","futures","keys","filter","streamName","has","forEach","primitive","variable","future"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Extracts a TIMESLICE message v1\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {LOG_STREAM_MESSAGE} from '../constants';\nimport {parseStreamFutures, parseStreamPrimitive, parseStreamVariable} from './parse-xviz-stream';\n\nexport default function parseTimesliceData(data, convertPrimitive) {\n  const {PRIMARY_POSE_STREAM} = getXVIZConfig();\n  const {vehicle_pose: vehiclePose, state_updates: stateUpdates, ...otherInfo} = data;\n\n  let timestamp;\n  if (vehiclePose) {\n    timestamp = vehiclePose.time;\n  } else if (stateUpdates) {\n    timestamp = stateUpdates.reduce((t, stateUpdate) => {\n      return Math.max(t, stateUpdate.timestamp);\n    }, 0);\n  }\n\n  if (!timestamp) {\n    // Incomplete stream message, just tag it accordingly so client can ignore it\n    return {type: LOG_STREAM_MESSAGE.INCOMPLETE};\n  }\n\n  const newStreams = {};\n  const result = {\n    ...otherInfo,\n    type: LOG_STREAM_MESSAGE.TIMESLICE,\n    streams: newStreams,\n    timestamp\n  };\n\n  if (stateUpdates) {\n    const xvizStreams = parseStateUpdates(stateUpdates, timestamp, convertPrimitive);\n    Object.assign(newStreams, xvizStreams);\n  }\n\n  if (vehiclePose) {\n    // v1 -> v2\n    newStreams[PRIMARY_POSE_STREAM] = vehiclePose;\n  }\n\n  return result;\n}\n\nfunction parseStateUpdates(stateUpdates, timestamp, convertPrimitive) {\n  const {STREAM_BLACKLIST} = getXVIZConfig();\n\n  const newStreams = {};\n  const primitives = {};\n  const variables = {};\n  const futures = {};\n\n  for (const stateUpdate of stateUpdates) {\n    Object.assign(primitives, stateUpdate.primitives);\n    Object.assign(variables, stateUpdate.variables);\n    Object.assign(futures, stateUpdate.futures);\n  }\n\n  Object.keys(primitives)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(primitive => {\n      newStreams[primitive] = parseStreamPrimitive(\n        primitives[primitive],\n        primitive,\n        timestamp,\n        convertPrimitive\n      );\n    });\n\n  Object.keys(variables)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(variable => {\n      newStreams[variable] = parseStreamVariable(variables[variable], variable, timestamp);\n    });\n\n  Object.keys(futures)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(future => {\n      newStreams[future] = parseStreamFutures(futures[future], future, timestamp, convertPrimitive);\n    });\n\n  return newStreams;\n}\n"],"file":"parse-timeslice-data-v1.js"}