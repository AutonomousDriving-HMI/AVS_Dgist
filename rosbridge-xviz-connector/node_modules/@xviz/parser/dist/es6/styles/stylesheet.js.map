{"version":3,"sources":["../../../src/styles/stylesheet.js"],"names":["XVIZStyleProperty","SELECTOR_REGEX","OPERATOR_REGEX","NULL_VALIDATOR","Stylesheet","constructor","data","rules","slice","reverse","map","rule","_parseSelector","name","selectors","validate","properties","_parseProperties","forEach","key","p","push","getProperty","propertyName","state","inlineProp","base","style","undefined","formatValue","match","find","getValue","getPropertyDefault","value","getDefault","getPropertyDependencies","attributes","selector","split","Object","keys","_getValidator","operator","object","classes","includes","selectorString","length","validators","every","result"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* eslint-disable no-console no-undef */\nimport XVIZStyleProperty from './xviz-style-property';\n\nconst SELECTOR_REGEX = /\\S+/g;\nconst OPERATOR_REGEX = /([=:~\\*\\^]+)/;\nconst NULL_VALIDATOR = () => true;\n\n/* Parser for single stylesheet */\nexport default class Stylesheet {\n  constructor(data = []) {\n    const rules = data\n      .slice()\n      // Newer rules override older ones\n      .reverse()\n      .map(rule => {\n        const {selectors, validate} = this._parseSelector(rule.name || '*');\n        const properties = this._parseProperties(rule);\n        return {selectors, validate, properties};\n      });\n\n    this.properties = {};\n    rules.forEach(rule => {\n      for (const key in rule.properties) {\n        let p = this.properties[key];\n        if (!p) {\n          p = [];\n          this.properties[key] = p;\n        }\n        p.push(rule);\n      }\n    });\n\n    this.rules = rules;\n  }\n\n  // Public methods\n\n  /**\n   * get style by property name for an object\n   * @param {String} propertyName - name of the style\n   * @param {Object} state - state descriptor of the object, used to match selectors\n   * @returns {Number|String|Array} style property value\n   */\n  getProperty(propertyName, state = {}) {\n    // inline style override any generic rules\n    const inlineProp = state.base && state.base.style && state.base.style[propertyName];\n    if (inlineProp !== undefined) {\n      return XVIZStyleProperty.formatValue(propertyName, inlineProp);\n    }\n\n    const rules = this.properties[propertyName];\n    const match = rules && rules.find(rule => rule.validate(state));\n    return match ? match.properties[propertyName].getValue(state) : null;\n  }\n\n  /**\n   * get default style by property name\n   * @param {String} propertyName - name of the style\n   * @returns {Number|String|Array} style property default value\n   */\n  getPropertyDefault(propertyName) {\n    const value = XVIZStyleProperty.getDefault(propertyName);\n    if (typeof value === 'function') {\n      return value(this);\n    }\n    return value;\n  }\n\n  /**\n   * get a list of attribute names that a property depends on.\n   * @param {String} propertyName - name of the style\n   * @returns {Array} - attribute names\n   */\n  getPropertyDependencies(propertyName) {\n    const attributes = {};\n    const rules = this.properties[propertyName];\n\n    if (!rules) {\n      return [];\n    }\n\n    rules.forEach(rule => {\n      rule.selectors.forEach(selector => {\n        if (selector !== '*') {\n          const [name] = selector.split(OPERATOR_REGEX);\n          attributes[name] = 1;\n        }\n      });\n    });\n\n    return Object.keys(attributes);\n  }\n\n  // Private methods\n\n  // Returns a function that checks if an object matches the given selector expressions\n  _getValidator(selector) {\n    if (selector === '*') {\n      return NULL_VALIDATOR;\n    }\n    const [name, operator, value] = selector.split(OPERATOR_REGEX);\n\n    switch (operator) {\n      case '=':\n        return object => object && object[name] === value;\n      default: {\n        return object => {\n          const classes = object && object.base && object.base.classes;\n          return object && ((classes && classes.includes(name)) || object[name]);\n        };\n      }\n    }\n  }\n\n  // Parses a selectorString (space-separated selector expressions)\n  _parseSelector(selectorString) {\n    const selectors = selectorString.match(SELECTOR_REGEX);\n    let validate;\n\n    // Special case handling\n    // Better perf than Array.every\n    if (selectors.length === 0 || selectors.includes('*')) {\n      validate = NULL_VALIDATOR;\n    } else if (selectors.length === 1) {\n      const match = this._getValidator(selectors[0]);\n      validate = object => match(object) || match(object.state);\n    } else {\n      const validators = selectors.map(this._getValidator);\n      validate = object => validators.every(match => match(object) || match(object.state));\n    }\n    return {selectors, validate};\n  }\n\n  // Parses property values\n  _parseProperties(properties) {\n    const result = {};\n\n    for (const key in properties.style) {\n      result[key] = new XVIZStyleProperty(key, properties.style[key]);\n    }\n    return result;\n  }\n}\n"],"file":"stylesheet.js"}