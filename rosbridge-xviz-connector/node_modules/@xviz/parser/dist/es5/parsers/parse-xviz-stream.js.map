{"version":3,"sources":["../../../src/parsers/parse-xviz-stream.js"],"names":["createPrimitiveMap","result","key","PRIMITIVE_CAT","parseXVIZStream","data","convertPrimitive","primitives","ui_primitives","variables","futures","streamName","Object","keys","map","datum","parseStreamPrimitive","timestamp","parseStreamVariable","parseStreamFutures","parseStreamUIPrimitives","time","OBJECT_STREAM","preProcessPrimitive","PRIMITIVE_SETTINGS","currentMajorVersion","XVIZPrimitiveSettingsV1","XVIZPrimitiveSettingsV2","primitiveData","Array","isArray","primType","type","objects","primitiveMap","category","objectIndex","length","object","LOOKAHEAD","push","j","primitive","isMainThread","id","XVIZObject","observe","pointCloud","joinObjectPointCloudsToTypedArrays","parseStreamFuturesV1","parseStreamFuturesV2","forEach","future","filter","Boolean","lookAheads","timestamps","future_set","futureIndex","normalizedPrimitive","parseStreamVariableV1","parseStreamVariableV2","variable","values","v","i","entry","base","valueData","getVariableData","object_id","parseStreamTimeSeries","seriesArray","streamBlackList","parseStreamTimeSeriesV2","log","error","ValueTypes","valuesObject","includes","timeSeriesStreams","timeSeriesEntry","streams","entryIndex","has","tsStream","warn","getVertexCount","vertices","Number","isFinite","getColorStride","colors","vertexCount","stride","DEFAULT_COLOR","numInstances","vertexColorStride","positions","Float32Array","Uint8ClampedArray","ids","Uint32Array","vertexPositions","vertexColors","colorStride","color","isColorFlattenedArray","set","isPositionFlattenedArray","fill","vertex","subarray","components","assign"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {PRIMITIVE_CAT, normalizeXVIZPrimitive} from './parse-xviz-primitive';\nimport XVIZObject from '../objects/xviz-object';\nimport {isMainThread} from '../utils/globals';\nimport log from '../utils/log';\nimport {getPrimitiveData} from './xviz-v2-common';\n\nimport XVIZPrimitiveSettingsV1 from './xviz-primitives-v1';\nimport XVIZPrimitiveSettingsV2 from './xviz-primitives-v2';\n\nfunction createPrimitiveMap() {\n  const result = {};\n  for (const key in PRIMITIVE_CAT) {\n    result[PRIMITIVE_CAT[key]] = [];\n  }\n  return result;\n}\n\n/* eslint-disable max-depth, max-statements, complexity, camelcase */\n// Handle stream-sliced data, via the ETL flow.\nexport function parseXVIZStream(data, convertPrimitive) {\n  // data is an array of objects\n  // Each object is [{primitives, variables, timestamp},...]\n  // Each object represents a timestamp and array of objects\n\n  // V1 has a no-data entry that results in setting all top-level types to an\n  // empty array. See the test cases.\n  //\n  // Usually only one of these fields is valid and thus only one is normally\n  // iterated below.\n  const {primitives, ui_primitives, variables, futures} = data[0];\n\n  // At this point, we either have one or the other.\n  // TODO(twojtasz): BUG: there is an assumption that\n  // streamNames will be unique.  Need to put in a detection if\n  // that is violated.\n  if (primitives) {\n    const streamName = Object.keys(primitives)[0];\n    return data.map(datum =>\n      parseStreamPrimitive(\n        datum.primitives[streamName],\n        streamName,\n        datum.timestamp,\n        convertPrimitive\n      )\n    );\n  } else if (variables) {\n    const streamName = Object.keys(variables)[0];\n    return data.map(datum =>\n      parseStreamVariable(datum.variables[streamName], streamName, datum.timestamp)\n    );\n  } else if (futures) {\n    const streamName = Object.keys(futures)[0];\n    return data.map(datum =>\n      parseStreamFutures(datum.futures[streamName], streamName, datum.timestamp, convertPrimitive)\n    );\n  } else if (ui_primitives) {\n    const streamName = Object.keys(ui_primitives)[0];\n    return data.map(datum =>\n      parseStreamUIPrimitives(datum.ui_primitives[streamName], streamName, datum.timestamp)\n    );\n  }\n\n  return {};\n}\n\n/* Processes an individual primitive time sample and converts the\n * data to UI elements.\n */\nexport function parseStreamPrimitive(primitives, streamName, time, convertPrimitive) {\n  const {OBJECT_STREAM, preProcessPrimitive} = getXVIZConfig();\n  const PRIMITIVE_SETTINGS =\n    getXVIZConfig().currentMajorVersion === 1 ? XVIZPrimitiveSettingsV1 : XVIZPrimitiveSettingsV2;\n\n  const primitiveData = getPrimitiveData(primitives);\n\n  if (!primitiveData || !Array.isArray(primitiveData.primitives)) {\n    return {};\n  }\n\n  const {type: primType, primitives: objects} = primitiveData;\n\n  const primitiveMap = createPrimitiveMap();\n\n  let category = null;\n  // Primitives are an array of XVIZ objects\n  for (let objectIndex = 0; objectIndex < objects.length; objectIndex++) {\n    const object = objects[objectIndex];\n\n    // array of primitives\n    if (object && Array.isArray(object)) {\n      category = PRIMITIVE_CAT.LOOKAHEAD;\n      primitiveMap[category].push([]);\n\n      for (let j = 0; j < object.length; j++) {\n        // Apply custom XVIZ pre processing to this primitive\n        preProcessPrimitive({primitive: object[j], streamName, time});\n\n        // process each primitive\n        const primitive = normalizeXVIZPrimitive(\n          PRIMITIVE_SETTINGS,\n          object[j],\n          objectIndex,\n          streamName,\n          primType,\n          time,\n          convertPrimitive\n        );\n        if (primitive) {\n          primitiveMap[category][objectIndex].push(primitive);\n        }\n      }\n    } else {\n      // single primitive\n\n      // Apply custom XVIZ postprocessing to this primitive\n      preProcessPrimitive({primitive: object, streamName, time});\n\n      // normalize primitive\n      const primitive = normalizeXVIZPrimitive(\n        PRIMITIVE_SETTINGS,\n        object,\n        objectIndex,\n        streamName,\n        primType,\n        time,\n        convertPrimitive\n      );\n\n      // Allow for v1 inline type to override primitive type\n      category = PRIMITIVE_SETTINGS[object.type || primType].category;\n      if (primitive) {\n        primitiveMap[category].push(primitive);\n\n        if (\n          isMainThread &&\n          // OBJECT_STREAM is deprecated, only keeping for backward compatibility\n          (streamName === OBJECT_STREAM ||\n            (!OBJECT_STREAM && primitive.id && category === 'features'))\n        ) {\n          XVIZObject.observe(primitive.id, time);\n        }\n      }\n    }\n  }\n\n  primitiveMap.pointCloud = joinObjectPointCloudsToTypedArrays(primitiveMap.pointCloud);\n  primitiveMap.time = time;\n\n  return primitiveMap;\n}\n\n/* Processes the futures and converts the\n * data to UI elements.\n */\nexport function parseStreamFutures(objects, streamName, time, convertPrimitive) {\n  const {currentMajorVersion} = getXVIZConfig();\n\n  return currentMajorVersion === 1\n    ? parseStreamFuturesV1(objects, streamName, time, convertPrimitive)\n    : parseStreamFuturesV2(objects, streamName, time, convertPrimitive);\n}\n\nexport function parseStreamFuturesV1(objects, streamName, time, convertPrimitive) {\n  const futures = [];\n  // objects = array of objects\n  // [{timestamp, primitives[]}, ...]\n\n  // Futures are an array of array of primitives and\n  // the objectIndex is used to find the timestamp associated\n  // with the set of primitives.\n  objects.forEach((object, objectIndex) => {\n    const {primitives} = object;\n\n    const future = primitives\n      .map(primitive =>\n        normalizeXVIZPrimitive(\n          XVIZPrimitiveSettingsV1,\n          primitive,\n          objectIndex,\n          streamName,\n          primitive.type,\n          time,\n          convertPrimitive\n        )\n      )\n      .filter(Boolean);\n\n    futures.push(future);\n  });\n\n  return {\n    time,\n    lookAheads: futures\n  };\n}\n\nexport function parseStreamFuturesV2(objects, streamName, time, convertPrimitive) {\n  const futures = [];\n\n  // objects = {\n  //   timestamps: [1, 2, 3],\n  //   primitives: [\n  //    { <type>: [ <objects for ts[1]> ] },\n  //    { <type>: [ <objects for ts[2]> ] },\n  //    { <type>: [ <objects for ts[3]> ] }\n  //   ]\n  // }\n\n  const timestamps = objects.timestamps;\n  objects.primitives.forEach((future_set, futureIndex) => {\n    // Get the underlying primitive array\n    const data = getPrimitiveData(future_set);\n\n    const future = data.primitives\n      .map(primitive => {\n        const normalizedPrimitive = normalizeXVIZPrimitive(\n          XVIZPrimitiveSettingsV2,\n          primitive,\n          futureIndex,\n          streamName,\n          data.type,\n          time,\n          convertPrimitive\n        );\n\n        normalizedPrimitive.timestamp = timestamps[futureIndex];\n        return normalizedPrimitive;\n      })\n      .filter(Boolean);\n\n    futures.push(future);\n  });\n\n  return {\n    time,\n    lookAheads: futures\n  };\n}\n\n/* Processes an individual variable time sample and converts the\n * data to UI elements.\n */\nexport function parseStreamVariable(objects, streamName, time) {\n  const {currentMajorVersion} = getXVIZConfig();\n\n  return currentMajorVersion === 1\n    ? parseStreamVariableV1(objects, streamName, time)\n    : parseStreamVariableV2(objects, streamName, time);\n}\n\nexport function parseStreamVariableV1(objects, streamName, time) {\n  if (Array.isArray(objects)) {\n    return {time};\n  }\n\n  let variable;\n  const {timestamps, values} = objects;\n  if (values.length === 1) {\n    variable = values[0];\n  } else if (timestamps) {\n    variable = values.map((v, i) => [timestamps[i], v]);\n  } else {\n    variable = values;\n  }\n\n  const entry = {\n    time,\n    variable\n  };\n\n  return entry;\n}\n\nexport function parseStreamVariableV2(objects, streamName, time) {\n  if (Array.isArray(objects)) {\n    return {time};\n  }\n\n  const variables = objects.variables;\n  if (!variables || !Array.isArray(variables)) {\n    return {};\n  }\n\n  const result = {time};\n\n  result.variable = variables\n    .map(entry => {\n      const {base, values} = entry;\n\n      const valueData = getVariableData(values);\n      if (!valueData || !valueData.values) {\n        return null;\n      }\n\n      const datum = {\n        values: valueData.values\n      };\n\n      if (base && base.object_id) {\n        datum.id = base.object_id;\n      }\n\n      return datum;\n    })\n    .filter(Boolean);\n\n  return result;\n}\n\n/* Processes a time_series sample and converts the\n * data to UI elements.\n */\nexport function parseStreamTimeSeries(seriesArray, streamBlackList) {\n  const {currentMajorVersion} = getXVIZConfig();\n\n  if (currentMajorVersion === 2) {\n    return parseStreamTimeSeriesV2(seriesArray, streamBlackList);\n  }\n\n  log.error(`Invalid time_series data in XVIZ version ${currentMajorVersion}`)();\n  return null;\n}\n\nconst ValueTypes = ['doubles', 'int32s', 'bools', 'strings'];\n\nfunction getVariableData(valuesObject) {\n  // Primitives have the type as the first key\n  const keys = Object.keys(valuesObject);\n\n  for (const type of keys) {\n    if (ValueTypes.includes(type)) {\n      return {type, values: valuesObject[type]};\n    }\n  }\n\n  // TODO(twojtasz): a more informative error path that doesn't abort processing\n  return {};\n}\n\nfunction parseStreamTimeSeriesV2(seriesArray, streamBlackList) {\n  if (!Array.isArray(seriesArray)) {\n    return {};\n  }\n\n  const timeSeriesStreams = {};\n  seriesArray.forEach(timeSeriesEntry => {\n    const {timestamp, streams, values, object_id} = timeSeriesEntry;\n    const valueData = getVariableData(values);\n\n    if (!valueData || valueData.values.length !== streams.length) {\n      return null;\n    }\n\n    valueData.values.forEach((variable, entryIndex) => {\n      const streamName = streams[entryIndex];\n\n      if (!streamBlackList.has(streamName)) {\n        const entry = {time: timestamp, variable};\n        if (object_id) {\n          entry.id = object_id;\n        }\n\n        const tsStream = timeSeriesStreams[streamName];\n\n        if (tsStream) {\n          // a duplicate entry is seen, leave the first entry.\n          log.warn(`Unexpected time_series duplicate: ${streamName}`)();\n        } else {\n          timeSeriesStreams[streamName] = entry;\n        }\n      }\n    });\n\n    // eslint consistent-return warning\n    // This for loop we do not need to return any value\n    return timeSeriesStreams;\n  });\n\n  return timeSeriesStreams;\n}\n\nfunction getVertexCount(vertices) {\n  return Number.isFinite(vertices[0]) ? vertices.length / 3 : vertices.length;\n}\n\nfunction getColorStride(colors, vertexCount) {\n  if (colors) {\n    if (colors.length / 4 === vertexCount) {\n      return 4;\n    }\n    if (colors.length / 3 === vertexCount) {\n      return 3;\n    }\n    let stride;\n    if (Array.isArray(colors[0])) {\n      stride = colors[0].length;\n    } else {\n      stride = colors.length;\n    }\n    if (stride === 3 || stride === 4) {\n      return stride;\n    }\n    log.error('Unknown point color format');\n  }\n  return 0;\n}\n\nconst DEFAULT_COLOR = [0, 0, 0, 255];\n\n// Joins a set of point clouds extracted from objects into a single point cloud\n// generates typed arrays that can be displayed efficiently by deck.gl\nfunction joinObjectPointCloudsToTypedArrays(objects) {\n  if (objects.length === 0) {\n    return null;\n  }\n\n  let numInstances = 0;\n  for (const object of objects) {\n    numInstances += getVertexCount(object.vertices);\n  }\n\n  let vertexColorStride = null;\n\n  const positions = new Float32Array(numInstances * 3);\n  const colors = new Uint8ClampedArray(numInstances * 4);\n\n  // Store object ids to enable recoloring.\n  // NOTE: Not a vertex attribute, ids are just efficiently stored as as 32 bit integers...\n  const ids = new Uint32Array(numInstances);\n\n  let i = 0;\n  objects.forEach(object => {\n    const vertexPositions = object.vertices;\n    // object.color is V1 and should be removed when deprecated\n    const vertexColors = object.colors;\n    const vertexCount = getVertexCount(vertexPositions);\n\n    if (vertexCount === 0) {\n      return;\n    }\n\n    // Setup for per-point color\n    const colorStride = getColorStride(vertexColors || object.color, vertexCount);\n    if (vertexColorStride !== null && vertexColorStride !== colorStride) {\n      log.error('Inconsistent point color format');\n    }\n    vertexColorStride = colorStride;\n\n    const isColorFlattenedArray =\n      vertexColors && vertexColors.length === vertexCount * vertexColorStride;\n    if (isColorFlattenedArray) {\n      colors.set(vertexColors, i * vertexColorStride);\n    }\n\n    const isPositionFlattenedArray = vertexPositions.length === vertexCount * 3;\n    if (isPositionFlattenedArray) {\n      positions.set(vertexPositions, i * 3);\n    }\n\n    if (Number.isFinite(object.id)) {\n      // v1 object ids\n      ids.fill(object.id, i, i + vertexCount);\n    }\n\n    if (isPositionFlattenedArray && (isColorFlattenedArray || !vertexColorStride)) {\n      // both positions and colors are populated\n      return;\n    }\n\n    let color = object.color || DEFAULT_COLOR;\n    for (let j = 0; j < vertexCount; j++, i++) {\n      if (!isPositionFlattenedArray) {\n        const vertex = vertexPositions[j];\n        positions[i * 3 + 0] = vertex[0];\n        positions[i * 3 + 1] = vertex[1];\n        positions[i * 3 + 2] = vertex[2];\n      }\n\n      if (!isColorFlattenedArray && vertexColorStride) {\n        if (vertexColors) {\n          color = vertexColors[j];\n        }\n        colors[i * vertexColorStride + 0] = color[0];\n        colors[i * vertexColorStride + 1] = color[1];\n        colors[i * vertexColorStride + 2] = color[2];\n        if (vertexColorStride === 4) {\n          colors[i * vertexColorStride + 3] = color[3] || 255;\n        }\n      }\n    }\n  });\n\n  return {\n    type: objects[0].type,\n    numInstances,\n    positions,\n    colors: vertexColorStride ? colors.subarray(0, vertexColorStride * numInstances) : null,\n    ids\n  };\n}\n\nexport function parseStreamUIPrimitives(components, streamName, time) {\n  return Object.assign({time}, components);\n}\n"],"file":"parse-xviz-stream.js"}